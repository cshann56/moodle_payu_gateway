{"version":3,"file":"pay.min.js","sources":["../src/pay.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This is an empty module, that is required before all other modules.\n * Because every module is returned from a request for any other module, this\n * forces the loading of all modules with a single request.\n *\n * @module     paygw_payuindia/payusubmit\n * @package\n * @copyright  2022 Christopher Shannon <cshannon108@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.11\n */\n\nimport jQuery from 'jquery';\nimport Ajax from 'core/ajax';\nimport notification from 'core/notification';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\n\nexport const init = () => {\n\n    /**\n    * Returns true if all fields are valid.\n    */\n    function validateVisibleFields() {\n\n        var retval = false;\n        var curFocusedElem = jQuery(\":focus\")[0];\n\n        // Causes a validation event to occur by triggering focus and blur events.\n        jQuery(\"#payuworkform input\").filter(\n            \"[name='email'],\" +\n            \"[name='phone'],\" +\n            \"[name='firstname'],\" +\n            \"[name='lastname'],\" +\n            \"[name='address1'],\" +\n            \"[name='address2'],\" +\n            \"[name='city'],\" +\n            \"[name='state'],\" +\n            \"[name='country'],\" +\n            \"[name='zipcode']\"\n            ).each(function(index, elem) {\n                    elem.focus();\n                    elem.blur();\n                });\n\n        // Return to original focused element\n        curFocusedElem.focus();\n\n        // Now find out how many elements are aria-invalid=true\n        var numInvalid = jQuery(\"#payuworkform input[aria-invalid='true']\").length;\n\n        if (numInvalid == 0) {\n            retval = true;\n        }\n\n        return retval;\n    }\n\n    function sendFormDataToRemote() {\n        // Disable the visible input fields.\n        jQuery(\"#payuworkform input[type='text']\").prop('disabled', true);\n        jQuery(\"#payuworkform select\").prop('disabled', true);\n\n        // Disable the pay and cancel buttons.\n        jQuery(\"#payusubmitbutton\").prop('disabled', true);\n        jQuery(\"#payucancelbutton\").prop('disabled', true);\n\n        // call the web service to get the hash of the reuqired fields.\n        var fieldvals = {};\n        jQuery(\"#payuworkform input,select\").filter(\n            \"[name='component'],\" +\n            \"[name='paymentarea'],\" +\n            \"[name='itemid'],\" +\n            \"[name='productinfo'],\" +\n            \"[name='amount'],\" +\n            \"[name='additional_charges'],\" +\n            \"[name='email'],\" +\n            \"[name='phone'],\" +\n            \"[name='firstname'],\" +\n            \"[name='lastname'],\" +\n            \"[name='address1'],\" +\n            \"[name='address2'],\" +\n            \"[name='city'],\" +\n            \"[name='state'],\" +\n            \"[name='country'],\" +\n            \"[name='zipcode'],\" +\n            \"[name='udf1']\"\n            ).each(function(index, elem) {\n                    fieldvals[elem.name] = elem.value;\n                });\n\n        var promises = Ajax.call([\n            {\n                methodname: 'paygw_payuindia_get_hash',\n                args: { inputparams: [{\n                    component: fieldvals[\"component\"],\n                    paymentarea: fieldvals[\"paymentarea\"],\n                    itemid: fieldvals[\"itemid\"],\n                    productinfo: fieldvals[\"productinfo\"],\n                    amount: fieldvals[\"amount\"],\n                    additional_charges: fieldvals[\"additional_charges\"],\n                    email: fieldvals[\"email\"],\n                    phone: fieldvals[\"phone\"],\n                    firstname: fieldvals[\"firstname\"],\n                    lastname: fieldvals[\"lastname\"],\n                    address1: fieldvals[\"address1\"],\n                    address2: fieldvals[\"address2\"],\n                    city: fieldvals[\"city\"],\n                    state: fieldvals[\"state\"],\n                    country: fieldvals[\"country\"],\n                    zipcode: fieldvals[\"zipcode\"],\n                    udf1: fieldvals[\"udf1\"]\n                    }] }\n            }]);\n\n        promises[0].done(function(response) {\n            response = response[0];\n\n            // Now update the fields.\n            jQuery(\"#payuworkform input[name='txnid']\").val(response['txnid']);\n            jQuery(\"#payuworkform input[name='key']\").val(response['key']);\n            jQuery(\"#payuworkform input[name='hash']\").val(response['hash']);\n\n            // Update the send form using values from the work form.\n            var mysendobjs = jQuery(\"#payusendform input,select\");\n\n            mysendobjs.each(\n                function(index, sendelem) {\n                    var workelem = jQuery(\"#payuworkform input,select\").filter(\"[name='\" + sendelem.name + \"']\")[0];\n                    sendelem.value = workelem.value;\n                }\n             );\n\n            // Submit the send to form.\n            var sendform = document.getElementById(\"payusendform\");\n\n            sendform.submit();\n\n        }).fail(function(ex) {\n            // Failure, so re-enable the fields and show a popup with the exception.\n            jQuery(\"#payuworkform input[type='text']\").prop('disabled', false);\n            jQuery(\"#payuworkform select\").prop('disabled', false);\n            jQuery(\"#payusubmitbutton\").prop('disabled', false);\n            jQuery(\"#payucancelbutton\").prop('disabled', false);\n            notification.exception(ex);\n        });\n    }\n\n    function cancelTransaction() {\n\n        var courseId = jQuery(\"#payuworkform input[name='courseid']\").val();\n        var wwwRoot  = jQuery(\"#payuworkform input[name='wwwroot']\").val();\n\n        var redirectUrl = wwwRoot + '/enrol/index.php?id=' + courseId;\n\n        // We don't want them coming back to this page with the back button.\n        // So, we simulate an HTTP recirect.\n        window.location.replace(redirectUrl);\n    }\n\n    var myActionButton = document.getElementById(\"payusubmitbutton\");\n\n    myActionButton.onclick = function() {\n\n        // Validate form using client side.\n        var validationResult = validateVisibleFields();\n\n        // exit function if validation result is not passed.\n        if (! validationResult) {\n            return;\n        } else { // Validation passed, so popup a modal form asking if user wants to continue\n\n            ModalFactory.create({\n                type: ModalFactory.types.SAVE_CANCEL,\n                title: 'Submit Payment',\n                body: 'Pressing OK will redirect your browser to '+\n                      'another website that will process your '+\n                      'payment. After the transaction is complete, '+\n                      'your browser will be redirected back to '+\n                      'this website. Do you want to continue?'\n                })\n                .then(function(modal) {\n                    modal.setSaveButtonText('OK');\n                    var root = modal.getRoot();\n                    root.on(ModalEvents.save, sendFormDataToRemote);\n                    modal.show();\n                });\n        }\n\n    };\n\n    var myCancelButton = document.getElementById(\"payucancelbutton\");\n\n    myCancelButton.onclick = function() {\n\n        ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: 'Cancel Payment',\n            body: 'Pressing OK will leave this page, '+\n                  'and all form data will be lost. '+\n                  'Do you want to continue?'\n            })\n            .then(function(modal) {\n                modal.setSaveButtonText('OK');\n                var root = modal.getRoot();\n                root.on(ModalEvents.save, cancelTransaction);\n                modal.show();\n            });\n    };\n\n    // Set up the Ajax call to repopulate states on change of country.\n\n    var myCountriesSelect = jQuery('#payuworkform select[name=\"country\"]');\n\n    myCountriesSelect[0].onclick = function() {\n\n        var curCountry = myCountriesSelect.val();\n\n        var promises2 = Ajax.call([\n            {\n                methodname: 'paygw_payuindia_get_stateregioninfo',\n                args: { country: curCountry }\n            }]);\n\n        promises2[0].done(function(response) {\n\n            var staterecs  = response[\"records\"].split(\"|\");\n            var stateField = jQuery(\"#payuworkform select[name='state']\");\n\n            // Now update the fields.\n            stateField.empty();\n            var sfDomObj = stateField[0]; // Get the HTMLDOM object.\n\n            for (var i = 0; i < staterecs.length; i++) {\n                var rec = staterecs[i].split(\";\");\n                var opt = document.createElement(\"option\");\n                opt.value = rec[0];\n                opt.text = rec[1];\n                sfDomObj.add(opt);\n            }\n\n        }).fail(function(ex) {\n            notification.exception(ex);\n        });\n    };\n};\n"],"names":["sendFormDataToRemote","prop","fieldvals","filter","each","index","elem","name","value","Ajax","call","methodname","args","inputparams","component","paymentarea","itemid","productinfo","amount","additional_charges","email","phone","firstname","lastname","address1","address2","city","state","country","zipcode","udf1","done","response","val","sendelem","workelem","document","getElementById","submit","fail","ex","exception","cancelTransaction","courseId","redirectUrl","window","location","replace","onclick","retval","curFocusedElem","focus","blur","length","create","type","ModalFactory","types","SAVE_CANCEL","title","body","then","modal","setSaveButtonText","getRoot","on","ModalEvents","save","show","myCountriesSelect","curCountry","staterecs","split","stateField","empty","sfDomObj","i","rec","opt","createElement","text","add"],"mappings":"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"}